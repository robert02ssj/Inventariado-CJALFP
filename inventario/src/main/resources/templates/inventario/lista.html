<!DOCTYPE html>
<html th:replace="~{layout/base :: layout(~{::section})}">
<body>

    <section>
        <div class="header-actions">
            <h2 style="color: #333; margin: 0;">Hist√≥rico de Asignaciones</h2>
            <a th:href="@{/inventario/asignar}" class="btn-create" style="background-color: #0056b3;">+ Asignar Equipo</a>
        </div>

        <form action="/inventario" method="get" class="search-container">
            <input type="text" name="busqueda" class="search-input" 
                   placeholder="Buscar por usuario, serie o modelo..."
                   th:value="${busquedaActual}">
        </form>

        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Usuario</th>
                        <th>Equipo</th>
                        <th>N¬∫ Serie</th>
                        <th>Fecha Asignaci√≥n</th>
                        <th>Fecha Devoluci√≥n</th>
                        <th>Documento</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="inv : ${inventarios}">
                        <td th:text="${inv.usuario.nombre + ' ' + (inv.usuario.apellidos != null ? inv.usuario.apellidos : '')}"></td>

                        <td th:text="${inv.equipo.modelo.nombre}"></td>
                        <td th:text="${inv.equipo.numeroSerie}"></td>

                        <td th:text="${#temporals.format(inv.fechaAsignacion, 'dd/MM/yyyy HH:mm')}"></td>
                        
                        <td>
                            <span th:if="${inv.fechaDevolucion != null}" 
                                  th:text="${#temporals.format(inv.fechaDevolucion, 'dd/MM/yyyy HH:mm')}"></span>
                            <span th:if="${inv.fechaDevolucion == null}" style="color: #007a33; font-weight: bold;">-</span>
                        </td>

                        <td style="text-align: center;">
                            <!-- Si TIENE documento -->
                            <div th:if="${inv.rutaPdf != null && inv.rutaPdf != ''}" 
                                 style="display: flex; gap: 5px; justify-content: center; align-items: center;">
                                
                                <a th:href="@{/inventario/descargar-pdf/{id}(id=${inv.id})}"
                                   class="btn-action"
                                   style="background: #007a33; padding: 5px 10px; border-radius: 4px; color: white; text-decoration: none;">
                                    üì• PDF
                                </a>
                                
                                <button type="button"
                                        th:data-id="${inv.id}"
                                        th:data-usuario="${inv.usuario.nombre + ' ' + inv.usuario.apellidos}"
                                        th:data-equipo="${inv.equipo.modelo.nombre + ' - ' + inv.equipo.numeroSerie}"
                                        onclick="abrirModalCambiar(this.dataset.id, this.dataset.usuario, this.dataset.equipo)"
                                        class="btn-action"
                                        style="background: #ffa500; padding: 5px 10px; border-radius: 4px; color: white; border: none; cursor: pointer;">
                                    üìù Cambiar
                                </button>
                                
                                <button type="button"
                                        th:data-id="${inv.id}"
                                        th:data-usuario="${inv.usuario.nombre + ' ' + inv.usuario.apellidos}"
                                        th:data-equipo="${inv.equipo.modelo.nombre + ' - ' + inv.equipo.numeroSerie}"
                                        onclick="confirmarEliminar(this.dataset.id, this.dataset.usuario, this.dataset.equipo)"
                                        class="btn-action btn-danger"
                                        style="background: #dc3545; padding: 5px 10px; border-radius: 4px; color: white; border: none; cursor: pointer;">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                            
                            <!-- Si NO TIENE documento -->
                            <div th:if="${inv.rutaPdf == null || inv.rutaPdf == ''}" 
                                 style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                                
                                <span style="color: #999; font-style: italic;">Sin documento</span>
                                
                                <button type="button"
                                        th:data-id="${inv.id}"
                                        th:data-usuario="${inv.usuario.nombre + ' ' + inv.usuario.apellidos}"
                                        th:data-equipo="${inv.equipo.modelo.nombre + ' - ' + inv.equipo.numeroSerie}"
                                        onclick="abrirModalSubir(this.dataset.id, this.dataset.usuario, this.dataset.equipo)"
                                        class="btn-create"
                                        style="padding: 5px 10px; border-radius: 4px; font-size: 0.9rem;">
                                    üì§ Subir PDF
                                </button>
                            </div>
                        </td>

                        <td>
                            <span th:if="${inv.fechaDevolucion == null}" 
                                  style="padding: 4px 8px; background-color: #d1e7dd; color: #0f5132; border-radius: 4px; font-size: 0.8rem;">
                                ACTIVO
                            </span>
                            <span th:if="${inv.fechaDevolucion != null}" 
                                  style="padding: 4px 8px; background-color: #e2e3e5; color: #41464b; border-radius: 4px; font-size: 0.8rem;">
                                HIST√ìRICO
                            </span>
                        </td>

                        <td>
                            <a th:if="${inv.fechaDevolucion == null}"
                               th:href="@{/inventario/devolver/{id}(id=${inv.id})}" 
                               class="btn-action"
                               style="background-color: #e6a500; color: white;"
                               onclick="return confirm('¬øConfirmas que el usuario ha devuelto este equipo? Pasar√° a estar Disponible.');">
                               Devolver
                            </a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- PAGINACI√ìN -->
        <div th:if="${totalPages > 1}" class="pagination-container">
            <div class="pagination-info">
                Mostrando 
                <span th:text="${currentPage * 10 + 1}">1</span> - 
                <span th:text="${currentPage * 10 + inventarios.size()}">10</span> 
                de <span th:text="${totalItems}">100</span> registros
            </div>
            
            <div class="pagination-controls">
                <!-- Bot√≥n Anterior -->
                <a th:if="${currentPage > 0}" 
                   th:href="@{''(page=${currentPage - 1}, busqueda=${busquedaActual})}" 
                   class="page-btn">
                    ‚óÄ Anterior
                </a>
                <span th:if="${currentPage == 0}" class="page-btn disabled">‚óÄ Anterior</span>
                
                <!-- N√∫meros de p√°gina -->
                <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                    <a th:if="${i != currentPage}" 
                       th:href="@{''(page=${i}, busqueda=${busquedaActual})}" 
                       class="page-number"
                       th:text="${i + 1}">1</a>
                    <span th:if="${i == currentPage}" 
                          class="page-number active"
                          th:text="${i + 1}">1</span>
                </span>
                
                <!-- Bot√≥n Siguiente -->
                <a th:if="${currentPage < totalPages - 1}" 
                   th:href="@{''(page=${currentPage + 1}, busqueda=${busquedaActual})}" 
                   class="page-btn">
                    Siguiente ‚ñ∂
                </a>
                <span th:if="${currentPage == totalPages - 1}" class="page-btn disabled">Siguiente ‚ñ∂</span>
            </div>
        </div>
    </section>

    <!-- ===== MODAL DE PDF ===== -->
    <div id="modalPdf" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalPdf()">&times;</span>
            
            <h2 id="modalTitulo">SUBIR DOCUMENTO PDF</h2>
            
            <div class="modal-body">
                <div class="info-asignacion">
                    <p><strong>Asignaci√≥n #</strong><span id="modalAsignacionId"></span></p>
                    <p><strong>Usuario:</strong> <span id="modalUsuario"></span></p>
                    <p><strong>Equipo:</strong> <span id="modalEquipo"></span></p>
                </div>
                
                <form id="formSubirPdf" method="post" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="form-label">üìÑ Seleccionar archivo PDF:</label>
                        <input type="file" 
                               id="pdfFileInput" 
                               name="pdfFile" 
                               accept=".pdf" 
                               class="form-control" 
                               required>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ‚ö†Ô∏è Solo archivos PDF. Tama√±o m√°ximo: 10MB
                        </small>
                    </div>
                    
                    <div class="form-actions" style="margin-top: 20px; text-align: right;">
                        <button type="button" onclick="cerrarModalPdf()" class="btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-create">
                            üì§ Subir PDF
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
    /* Estilos del modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border: 1px solid #888;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .modal-content h2 {
        background-color: #007a33;
        color: white;
        margin: 0;
        padding: 15px 20px;
        border-radius: 8px 8px 0 0;
    }

    .modal-body {
        padding: 20px;
    }

    .close {
        color: white;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 20px;
    }

    .close:hover,
    .close:focus {
        color: #ddd;
    }

    .info-asignacion {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #007a33;
    }

    .info-asignacion p {
        margin: 5px 0;
    }
    </style>

    <script>
    // ===== MODAL DE PDF - VERSI√ìN 2.0 =====
    // Cache busting: Forzar recarga del navegador

    (function() {
        'use strict';
        
        console.log('üîß Inicializando m√≥dulo de gesti√≥n de PDFs v2.0');
        
        let asignacionActual = null;

        // Helper function para validar elementos del modal
        function validarElementosModal() {
            const modal = document.getElementById('modalPdf');
            const titulo = document.getElementById('modalTitulo');
            const asignacionIdSpan = document.getElementById('modalAsignacionId');
            const usuarioSpan = document.getElementById('modalUsuario');
            const equipoSpan = document.getElementById('modalEquipo');
            const form = document.getElementById('formSubirPdf');
            const fileInput = document.getElementById('pdfFileInput');
            
            if (!modal || !titulo || !asignacionIdSpan || !usuarioSpan || !equipoSpan || !form || !fileInput) {
                console.error('‚ùå Error: No se encontraron elementos del modal');
                alert('Error: El modal no est√° disponible. Por favor, recarga la p√°gina.');
                return null;
            }
            
            return { modal, titulo, asignacionIdSpan, usuarioSpan, equipoSpan, form, fileInput };
        }

        // Definir funciones en el scope global expl√≠citamente
        window.abrirModalSubir = function(id, usuario, equipo) {
            console.log('‚úÖ abrirModalSubir llamado:', id, usuario, equipo);
            asignacionActual = id;
            
            const elementos = validarElementosModal();
            if (!elementos) return;
            
            elementos.titulo.textContent = 'SUBIR DOCUMENTO PDF';
            elementos.asignacionIdSpan.textContent = id;
            elementos.usuarioSpan.textContent = usuario;
            elementos.equipoSpan.textContent = equipo;
            elementos.form.action = '/inventario/subir-pdf/' + id;
            elementos.fileInput.value = '';
            elementos.modal.style.display = 'block';
        };

        window.abrirModalCambiar = function(id, usuario, equipo) {
            console.log('‚úÖ abrirModalCambiar llamado:', id, usuario, equipo);
            asignacionActual = id;
            
            const elementos = validarElementosModal();
            if (!elementos) return;
            
            elementos.titulo.textContent = 'CAMBIAR DOCUMENTO PDF';
            elementos.asignacionIdSpan.textContent = id;
            elementos.usuarioSpan.textContent = usuario;
            elementos.equipoSpan.textContent = equipo;
            elementos.form.action = '/inventario/cambiar-pdf/' + id;
            elementos.fileInput.value = '';
            elementos.modal.style.display = 'block';
        };

        window.cerrarModalPdf = function() {
            console.log('‚úÖ cerrarModalPdf llamado');
            const modal = document.getElementById('modalPdf');
            if (modal) {
                modal.style.display = 'none';
            }
            asignacionActual = null;
        };

        window.confirmarEliminar = function(id, usuario, equipo) {
            console.log('‚úÖ confirmarEliminar llamado:', id, usuario, equipo);
            
            // Escape HTML entities to prevent XSS
            const escapeHtml = function(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };
            
            const mensaje = '¬øEst√°s seguro de eliminar el documento PDF de:\n\n' + 
                            'Usuario: ' + escapeHtml(usuario) + '\n' +
                            'Equipo: ' + escapeHtml(equipo) + '\n\n' +
                            'Esta acci√≥n no se puede deshacer.';
            
            if (confirm(mensaje)) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/inventario/eliminar-pdf/' + id;
                document.body.appendChild(form);
                form.submit();
            }
        };

        // Cerrar modal al hacer click fuera de √©l
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('modalPdf');
            if (modal && event.target === modal) {
                window.cerrarModalPdf();
            }
        });

        // Verificaci√≥n de inicializaci√≥n
        console.log('‚úÖ M√≥dulo de PDFs cargado correctamente v2.0');
        console.log('‚úÖ Funciones disponibles:', {
            abrirModalSubir: typeof window.abrirModalSubir,
            abrirModalCambiar: typeof window.abrirModalCambiar,
            cerrarModalPdf: typeof window.cerrarModalPdf,
            confirmarEliminar: typeof window.confirmarEliminar
        });
    })();
    </script>

</body>
</html>