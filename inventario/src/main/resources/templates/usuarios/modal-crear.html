<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="modal-crear-usuario">
    <div id="modalNuevoUsuario" class="modal-quick-create" style="display: none;">
        <div class="modal-content-quick">
            <div class="modal-header-quick">
                <h3>Nuevo Usuario</h3>
                <span class="close-quick" onclick="cerrarModalUsuario()">&times;</span>
            </div>
            
            <div class="modal-body-quick">
                <form id="formNuevoUsuario" onsubmit="guardarNuevoUsuario(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre: <span style="color: red;">*</span></label>
                        <input type="text" 
                               id="nombreUsuarioNuevo" 
                               class="form-control" 
                               placeholder="Nombre del usuario" 
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Apellidos: <span style="color: red;">*</span></label>
                        <input type="text" 
                               id="apellidosUsuarioNuevo" 
                               class="form-control" 
                               placeholder="Apellidos del usuario" 
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Usuario LDAP:</label>
                        <input type="text" 
                               id="ldapUsuarioNuevo" 
                               class="form-control" 
                               placeholder="Ej: jgarcia">
                    </div>
                    
                    <div class="form-actions-quick">
                        <button type="button" onclick="cerrarModalUsuario()" class="btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-create">
                            ✅ Guardar Usuario
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function abrirModalUsuario() {
    document.getElementById('modalNuevoUsuario').style.display = 'block';
    document.getElementById('nombreUsuarioNuevo').focus();
}

function cerrarModalUsuario() {
    document.getElementById('modalNuevoUsuario').style.display = 'none';
    document.getElementById('formNuevoUsuario').reset();
}

function guardarNuevoUsuario(event) {
    event.preventDefault();
    
    const nombre = document.getElementById('nombreUsuarioNuevo').value.trim();
    const apellidos = document.getElementById('apellidosUsuarioNuevo').value.trim();
    const ldap = document.getElementById('ldapUsuarioNuevo').value.trim();
    
    if (!nombre || !apellidos) {
        alert('⚠️ Nombre y apellidos son obligatorios');
        return;
    }
    
    fetch('/usuarios/guardar-ajax', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            nombre: nombre,
            apellidos: apellidos,
            ldap: ldap || null
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Error al guardar');
        return response.json();
    })
    .then(usuario => {
        const select = document.querySelector('select[name="usuario"]') || 
                       document.querySelector('select[name="usuario.id"]');
        
        if (select) {
            const option = document.createElement('option');
            option.value = usuario.id;
            option.text = `${usuario.nombre} ${usuario.apellidos}`;
            option.selected = true;
            select.add(option);
        }
        
        cerrarModalUsuario();
        
        const mensaje = document.createElement('div');
        mensaje.className = 'flash-message flash-success';
        mensaje.innerHTML = `<span>✅ Usuario "${usuario.nombre} ${usuario.apellidos}" creado correctamente</span>`;
        mensaje.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 3000; padding: 15px 20px; background: #d1e7dd; color: #0f5132; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
        document.body.appendChild(mensaje);
        
        setTimeout(() => mensaje.remove(), 3000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al crear el usuario');
    });
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') cerrarModalUsuario();
});

window.addEventListener('click', function(event) {
    const modal = document.getElementById('modalNuevoUsuario');
    if (event.target === modal) cerrarModalUsuario();
});
</script>

</body>
</html>
