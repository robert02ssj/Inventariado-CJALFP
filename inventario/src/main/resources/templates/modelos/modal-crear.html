<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="modal-crear-modelo">
    <div id="modalNuevoModelo" class="modal-quick-create" style="display: none;">
        <div class="modal-content-quick">
            <div class="modal-header-quick">
                <h3>Nuevo Modelo</h3>
                <span class="close-quick" onclick="cerrarModalModelo()">&times;</span>
            </div>
            
            <div class="modal-body-quick">
                <form id="formNuevoModelo" onsubmit="guardarNuevoModelo(event)">
                    <div class="form-group">
                        <label class="form-label">Nombre del Modelo: <span style="color: red;">*</span></label>
                        <input type="text" 
                               id="nombreModeloNuevo" 
                               class="form-control" 
                               placeholder="Ej: Galaxy S23, ThinkPad X1..." 
                               required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Marca: <span style="color: red;">*</span></label>
                        <select id="marcaModeloNuevo" class="form-control" required>
                            <option value="">-- Selecciona una marca --</option>
                            <option th:each="m : ${marcas}" 
                                    th:value="${m.id}" 
                                    th:text="${m.nombreFabricante}">
                            </option>
                        </select>
                    </div>
                    
                    <div class="form-actions-quick">
                        <button type="button" onclick="cerrarModalModelo()" class="btn-secondary">
                            Cancelar
                        </button>
                        <button type="submit" class="btn-create">
                            ✅ Guardar Modelo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function abrirModalModelo() {
    document.getElementById('modalNuevoModelo').style.display = 'block';
    document.getElementById('nombreModeloNuevo').focus();
}

function cerrarModalModelo() {
    document.getElementById('modalNuevoModelo').style.display = 'none';
    document.getElementById('formNuevoModelo').reset();
}

function guardarNuevoModelo(event) {
    event.preventDefault();
    
    const nombre = document.getElementById('nombreModeloNuevo').value.trim();
    const marcaId = document.getElementById('marcaModeloNuevo').value;
    
    if (!nombre || !marcaId) {
        alert('⚠️ Todos los campos son obligatorios');
        return;
    }
    
    fetch('/modelos/guardar-ajax', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            nombre: nombre,
            marca: { id: parseInt(marcaId) }
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Error al guardar');
        return response.json();
    })
    .then(modelo => {
        const select = document.querySelector('select[name="modelo"]') || 
                       document.querySelector('select[name="modelo.id"]');
        
        if (select) {
            const option = document.createElement('option');
            option.value = modelo.id;
            // Include brand name for consistency with existing format
            option.text = modelo.marca.nombreFabricante + ' - ' + modelo.nombre;
            option.selected = true;
            select.add(option);
        }
        
        cerrarModalModelo();
        
        const mensaje = document.createElement('div');
        mensaje.className = 'flash-message flash-success';
        mensaje.innerHTML = `<span>✅ Modelo "${modelo.nombre}" creado correctamente</span>`;
        mensaje.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 3000; padding: 15px 20px; background: #d1e7dd; color: #0f5132; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);';
        document.body.appendChild(mensaje);
        
        setTimeout(() => mensaje.remove(), 3000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('❌ Error al crear el modelo');
    });
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') cerrarModalModelo();
});

window.addEventListener('click', function(event) {
    const modal = document.getElementById('modalNuevoModelo');
    if (event.target === modal) cerrarModalModelo();
});
</script>

</body>
</html>
